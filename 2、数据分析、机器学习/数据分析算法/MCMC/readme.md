# `MCMC 马尔科夫链蒙特卡罗方法`

## `MC`

* 蒙特卡罗方法又称统计模拟法、随机抽样技术，是一种随机模拟方法，以概率和统计理论方法为基础的一种计算方法，是使用随机数（或更常见的伪随机数）来解决很多计算问题的方法。将所求解的问题同一定的概率模型相联系，用电子计算机实现统计模拟或，以获得问题的近似解。为象征性地表明这一方法的概率统计特征，故借用赌城蒙特卡罗命名。

* MCMC的目的是这样：事先知道要采样的真实分布是什么（即平稳分布），但很难在现实中对该分布进行采样，所以利用马尔可夫链的性质，通过 M_H 采样获得满足平稳分布的样本点。然后这些采样点本身就就刻画出了了真实的概率分布是怎么样的。

* MCMC只是为了解决分布已知，但是难采样的问题。如果分布不知，那么MCMC是无能为力的。

## `接受 - 拒绝采样过程：`


* 当 `cdf(累积分布函数)` 很难求解的时候，我们就不能通过求 `cdf(累积分布函数)` 的 `反函数` 来求得样本 `xi`。那么此时我们可以通过构造一个近似 `f(x)` 的分布 `q(x)` 来对 `f(x)` 进行近似，达到接近 `f(x)` 的目的，这个 `q(x)` 必须满足 `m * q(x) > f(x) `这个条件。

    <div align=center><img  src="./static/引出接受拒绝采样1.jpg"/></div>

* 如何对样本 `x` 进行 `接受` 和 `拒绝`：


    <div align=center><img  src="./static/接受和拒绝条件.jpg"/></div>



### `接受拒绝 - 采样存在的问题：`

* 1）对于一些二维分布 `p(x,y)`，有时候我们只能得到条件分布 `p(x|y)` 和 `p(y|x)` 和,却很难得到二维分布 `p(x,y)` 一般形式，这时我们无法用 `接受-拒绝采样` 得到其样本集。

* 2）对于一些高维的复杂非常见分布 `p(x1,x2,...,xn)` ，我们要找到一个合适的 `q(x)` 和 `k` 非常困难。


### 补充：`为什么当 p(x) 概率分布很复杂的时候，很难进行采样，而需要使用比如：接受拒绝-采样、重参数采样等方法？`

* `蒙特卡洛采样中（重要采样），为什么从Px中采样困难？：`https://www.zhihu.com/question/313194059


    <div align=center><img width="600" height="340" src="./static/引出接受拒绝采样2.jpg"/></div>


## `马尔可夫链`

* 在蒙特卡罗方法中，我们采集大量的样本，构造一个合适的概率模型，对这个模型进行大量的采样和统计实验，使它的某些统计参量正好是待求问题的解。但是，我们需要大量采样，虽然我们有拒绝-接受采样和重采样技术，但是依旧面临采样困难的问题。

* 马尔科夫链就是帮助找到这些复杂概率分布的对应的采样样本集的白衣骑士。


* `M-H的确没有选择的函数比目标分布要大的要求，因为他的采样方式是通过马尔科夫链转移，而不是直接的拒绝采样。`关于选择转移矩阵技巧，如果是离散的转移矩阵，其实随机选择一个也行，关于条件概率，则一般喜欢使用正态分布，因为对于的算法库API功能丰富，方便采样。


## `HM`

首先跟拒绝算法类似，MH也是通过熟悉的分布去采样一个复杂的分布，但区别在于两点:

* （1）MH中自定义的分布与原分布不一定相似

* （2）接受率的定义不同，MH中的接受率是（某一状态）与（这一状态通过自定义分布的条件概率产生的下一个状态）在原分布中概率的大小的比值；而拒绝采样的接受率是在（自定义分布）中根据均匀分布产生一个点，然后看他落在（自定义分布）还是（原分布）的概率中。

需要确定的一点：

* （1）原分布与自定义分布的定义域需要一致，这样才能用自定义分布采样出符合原分布定义域的样本

有可能导致的问题：
* （1）如果自定义分布与原分布相差很多，则在某一区间内，可能自定义分布产生大量样本，但是原分布中只存在少量。此时只能用接受率，拒绝大量的样本。反之亦然。这就是效率低下的原因。


### `MH 采样过程：`

* MH 采样步骤分解：

    <div align=center><img src="./static/MH采样过程.jpg"/></div>

    * `1`、给定任意 `转移矩阵Q` 和 `平稳分布 π(x)`

    * `2`、在 `t = 0` ，随机产生一个 `初始状态 x0`。

    * `3`、`x0 * Q(x|x0) (状态转移矩阵) = 新的状态的概率分布`，然后再这个新的状态的概率分布中采出一个样本 `x*`

    * `4`、但是采出的样本 `x*` 不一定符合 `平稳分布(π(x))` ，所以要以 `metropolits` 的方法来进行一定概率的拒绝，再均匀分布里面随机抽取一个 `u` 。

    * `5`、若 `u < α`，那 `接受 x*` , 更新： `t = 1` , `x1 = x*` 

    * `6`、若不满足 `u < α`，那就 `拒绝采样`，更新： `t = 1` , `x1 = x0` 

    * `7`、继续进行以上步骤，如果 `u < α` 成立，那么 `x1 = x*` ，状态变为了 `x1` 。

    * `8`、`x1 * Q(x|x1) (状态转移矩阵) = 新的状态的概率分布` ，然后再这个新的状态的概率分布中采出一个新的样本 `x*`

    * `9`、 .........

    * `10`、直到满足一定的轮询次数，到达平衡 (平稳分布)，比如称为 `t > T` 时刻。

    * `11`、当到达平衡后，也就是 `t > T` 时刻之后，所有的样本都是平稳分布的样本，那就完成了一个 MCMC 抽样的过程

    * `12`、当然 `t > T` 时刻之后，也需要进行拒绝采样的判断，还是要进行 `u < α` 的比较的。



## 参考：


* `你一定从未看过如此通俗易懂的马尔科夫链蒙特卡罗方法(MCMC)解读(上)：`https://zhuanlan.zhihu.com/p/250146007


* `你一定从未看过如此通俗易懂的马尔科夫链蒙特卡罗方法(MCMC)解读(下): `https://zhuanlan.zhihu.com/p/253784711

* `MCMC(一)蒙特卡罗方法：`https://www.cnblogs.com/pinard/p/6625739.html


* `MCMC(三)MCMC采样和M-H采样: `https://www.cnblogs.com/pinard/p/6638955.html#!comments

* `蒙特卡洛（Monte Carlo, MCMC）方法的原理和应用: `https://www.bilibili.com/video/BV17D4y1o7J2




## 相关疑问：

问：

    for t=0 to n1+n2−1:
    a) 从条件概率分布Q(x|xt)中采样得到样本x∗
    b) 从均匀分布采样u∼uniform[0,1]
    c) 如果u<α(xt,x∗)=π(x∗)Q(x∗,xt), 则接受转移xt→x∗，即xt+1=x∗
    d) 否则不接受转移，t=max(t−1,0)

    u是[0,1]上的随机数，是否意味着c)步中拒绝和接受也是随机的？因为u<α由u的随机性决定。

答：

    是的，接受和拒绝满足随机性，类似之前讲到的接受-拒绝采样。


<div align=center><img src="./static/problem/1.jpg"/></div>

<div align=center><img  src="./static/problem/2.jpg"/></div>
