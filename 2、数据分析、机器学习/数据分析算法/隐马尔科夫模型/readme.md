# 隐马尔可夫模型


## `马尔科夫性质：`


* 马尔科夫链遵从马尔可夫性质：也就是未来状态的条件概率分布只依赖于当前时刻：

    <div align=center><img  src="./static/马尔可夫性质.jpg"/></div>



## `马尔可夫模型：`

* 既然某一时刻状态转移的概率只依赖于它的前一个状态，那么我们只要能求出系统中任意两个状态之间的转换概率，这个马尔科夫链的模型就定了。

* 下图马尔科夫链是表示股市模型的，共有三种状态：牛市（Bull market）, 熊市（Bear market）和横盘（Stagnant market）。每一个状态都以一定的概率转化到下一个状态。比如，牛市以0.025的概率转化到横盘的状态。这个状态概率转化图可以以矩阵的形式表示。如果我们定义矩阵阵P某一位置P(i,j)的值为P(j|i),即从状态i转化到状态j的概率，并定义牛市为状态0， 熊市为状态1, 横盘为状态2. 这样我们得到了马尔科夫链模型的状态转移矩阵。

    <div align=center><img  src="./static/马尔科夫链.png"/></div>


* 有了状态转移矩阵之后就可以预测下一次的状态的概率是多少，比如今天 `牛市的概率为30%` ， `熊盘的概率为40%` ，`横盘的概率为30%` ，也就是 `[0.3,0.4,0.3]`


    然后这个状态作为序列概率分布的 `初始状态 t0 [0.3,0.4,0.3]`，将其带入这个状态转移矩阵计算 `t1` , `t2` , `t3` ...的状态。

    下一个状态依赖于当前状态：`t1 = t0 * 状态转移矩阵`


### 代码示例：

    import numpy as np
    matrix = np.matrix([[0.9,0.075,0.025],[0.15,0.8,0.05],[0.25,0.25,0.5]], dtype=float)
    vector1 = np.matrix([[0.3,0.4,0.3]], dtype=float)
    for i in range(100):
        vector1 = vector1 * matrix
        print("Current round:" , i+1)
        print(vector1)

    --> 60次轮询后，可以看到最后得到的状态概率分布已经不变，成为平稳分布。<--

    Current round: 1
    [[ 0.405   0.4175  0.1775]]
    Current round: 2
    [[ 0.4715   0.40875  0.11975]]
    Current round: 3
    [[ 0.5156  0.3923  0.0921]]
    Current round: 4
    [[ 0.54591   0.375535  0.078555]]
    。。。。。。
    Current round: 58
    [[ 0.62499999  0.31250001  0.0625    ]]
    Current round: 59
    [[ 0.62499999  0.3125      0.0625    ]]
    Current round: 60
    [[ 0.625   0.3125  0.0625]]
    。。。。。。
    Current round: 99
    [[ 0.625   0.3125  0.0625]]
    Current round: 100
    [[ 0.625   0.3125  0.0625]]



### `马尔科夫链模型状态转移矩阵的性质`

* 不论你当前状态是什么，通过状态转移矩阵，最后都能得到一个平稳的概率分布。也就是说我们的马尔科夫链模型的状态转移矩阵收敛到的稳定概率分布与我们的初始状态概率分布无关。


### `马尔可夫状态转移矩阵`

* 马尔可夫状态转移矩阵必须满足：所有状态可遍历性和非周期性。

   <div align=center><img  src="./static/马尔科夫状态转移矩阵.jpg"/></div>


* `周期性：`https://www.zhihu.com/question/366011083

## 隐马尔科夫模型

* 股市状态是 `隐状态`，上涨下跌不变是 `观测状态`。

    <div align=center><img  src="./static/隐马尔科夫模型/2.jpg"/></div>


* 补充说明：

  一、`股市状态` 到 `观测状态：`

  * 其中的 `b0(0)` 为当前状态为牛市，它上涨的概率

  * 其中的 `b0(1)` 为当前状态为牛市，它下跌的概率

  * 其中的 `b0(2)` 为当前状态为牛市，它不变的概率

  意味着只要知道股市的状态结合观测状态生成矩阵我们就可以得到观测状态发生的概率。

  二、`股市自身的状态转移：`
    
    * 可以写成状态转移矩阵的形式。

    `股市状态` 的判断是一个 `马尔科夫链` ，股市状态到`观测状态的过程` 称为 `一般随机过程` ，所以说隐马尔科夫模型是 `马尔科夫链` + `一般随机过程`


### `HMM 模型`
 
通过 `状态转移矩阵`、`观测状态生成矩阵`、`隐状态初始概率分布` 我们就可以构造一个 `HMM 模型`。

<div align=center><img  src="./static/隐马尔科夫模型/构成HMM.jpg"/></div>

隐状态初始概率分布和状态转移矩阵，我们就可以知道任意时刻的状态是如何演化。

有了各个时刻的隐状态，再结合观测状态生成矩阵，就可以知道观测的东西随时间是如何演化的。


### `HMM 的三个基本问题：`

`λ 是 HMM 模型`

* 1、观测的东西随时间是如何演化的概率分别是多少

    <div align=center><img  src="./static/隐马尔科夫模型/first.jpg"/></div>

    在 λ 这个模型的条件下，O 这个观测序列的概率是多少。


* 2、模型参数的学习：通过已有的数据来推断模型是什么，即推断 λ 是什么。

    <div align=center><img  src="./static/隐马尔科夫模型/second.jpg"/></div>

    通过发生的事情来推断最有可能的 HMM 模型参数。

* 3、预测(解码)问题：

    <div align=center><img  src="./static/隐马尔科夫模型/third.jpg"/></div>

    根据`模型` 和 `观测数据` 来推 `隐状态`。

### 第一个问题：`求观测序列的概率`

* 给了`参数模型 λ` 和 `观测状态序列 O` ，现在要求得是发生这种情况的可能性 `P(O|λ)` 有多大。 

    <div align=center><img  src="./static/隐马尔科夫模型/第一个问题.jpg"/></div>


* 观测给定模型的情况下，当前观测序列发生的概率 `P(O|λ)` <-- 就是我们要求解的。

* 也可以写成：`P(O|λ) = Σ P(O,I|λ)` 在模型已知的情况下给定隐状态的时候观测序列发生的概率之和。 

* 现在我们知道了 `P(O|λ) = Σ P(O,I|λ)` 那么 `Σ P(O,I|λ)` 如何求解呢？

    * 得到在 `λ` 条件下，当 `I = 某个状态`,出现 `O` 这个观测序列的概率： `P(O,I|λ) = P(I|λ) * P(O|I,λ)`

    * 其中 `P(I|λ) = π(i1) * a(i1,i2) * a(i2,i3)...a(ir-1,ir)`
    
        其中 `a(i1,i2)` 表 `i1时刻` 转到 `i2时刻` 的概率。

    * `P(O|i,λ) = bi1(o1)bi2(o2)...bir(or)` 的概率
    
* 则有：

    <div align=center><img  src="./static/隐马尔科夫模型/暴力求解.jpg"/></div>

    但是算法存在问题，当复杂度高的时候求解难度大。


`前向和后相算法：`


* `前向概率：`

    在前向算法中，通过定义 `“前向概率”` 来定义动态规划的这个局部状态。什么是前向概率呢, 其实定义很简单，记为：

    <div align=center><img  src="./static/隐马尔科夫模型/前向概率.jpg"/></div>

    即为在 λ 模型给定的情况下，定义时刻t时隐藏状态为 `qi`, 观测状态的序列为 `o1,o2,...ot` 的概率为前向概率。

    `前向算法公式：`

    <div align=center><img  src="./static/隐马尔科夫模型/前向算法1.jpg"/></div>

    中括号意思就是当前层的所有 `N个隐状态` 与下一层的 `第i个状态` 的连接，里面的 `α` 是到 `时刻t` 部分 `观测序列为 o1,o2,...ot` ，且在 `t 时刻` 处于 `状态 j` 的概率，`a` 是 `t 时刻` 第 `j 个状态` 到 `t+1 时刻` 第 `i 个状态` 的转移情况（转移矩阵给出）；
    
    `中括号` 外面乘以的 `b` 是当前状态下，`对应观测情况发生的概率`，比如当前是牛市，那么牛市对应上涨的概率是什么呢? 就是b。


    <div align=center><img width="400" height="200"  src="./static/隐马尔科夫模型/前向算法2.jpg"/></div>

    `总结得到：`

    <div align=center><img  src="./static/隐马尔科夫模型/前向算法3.jpg"/></div>

    `案例：`

    <div align=center><img  src="./static/隐马尔科夫模型/前向算法5.jpg"/></div>


    <div align=center><img  src="./static/隐马尔科夫模型/前向算法4.jpg"/></div>


* `后向概率：`

    `文字说明：`

    <div align=center><img  src="./static/隐马尔科夫模型/后向概率1-1.jpg"/></div>

    `后向概率推导：`

    <div align=center><img  src="./static/隐马尔科夫模型/后向概率推导.jpg"/></div>



    `隐马尔科夫模型HMM（二）前向后向算法评估观察序列概率：`https://www.cnblogs.com/pinard/p/6955871.html#!comments

    `HMM模型 - 前后向算法：`http://www.armigo.fun/2020/02/23/HMM/

### `第二个问题：鲍姆-韦尔奇算法求解 HMM 参数`









## `参考：`


* `MCMC(二)马尔科夫链：`https://www.cnblogs.com/pinard/p/6632399.html

* `HMM模型：`http://www.armigo.fun/2020/02/23/HMM/


* `第一个问题：隐马尔科夫模型HMM（二）前向后向算法评估观察序列概率：`https://www.cnblogs.com/pinard/p/6955871.html#!comments


* `Video - 隐马尔科夫模型详解：`https://www.bilibili.com/video/BV13C4y1W7iB


